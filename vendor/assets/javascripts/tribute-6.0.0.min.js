class e{constructor(e){this.tribute=e,this.tribute.events=this}static keys(){return[{key:9,value:"TAB"},{key:8,value:"DELETE"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:32,value:"SPACE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}bind(e){e.boundKeydown=this.keydown.bind(e,this),e.boundKeyup=this.keyup.bind(e,this),e.boundInput=this.input.bind(e,this),e.addEventListener("keydown",e.boundKeydown,!0),e.addEventListener("keyup",e.boundKeyup,!0),e.addEventListener("input",e.boundInput,!0)}unbind(e){e.removeEventListener("keydown",e.boundKeydown,!0),e.removeEventListener("keyup",e.boundKeyup,!0),e.removeEventListener("input",e.boundInput,!0),delete e.boundKeydown,delete e.boundKeyup,delete e.boundInput}keydown(t,i){t.shouldDeactivate(i)&&(t.tribute.isActive=!1,t.tribute.hideMenu());let n=this;t.commandEvent=!1,e.keys().forEach((e=>{e.key===i.keyCode&&(t.commandEvent=!0,t.callbacks()[e.value.toLowerCase()](i,n))}))}input(e,t){e.inputEvent=!0,e.keyup.call(this,e,t)}click(e,t){let i=e.tribute;if(i.menu&&i.menu.contains(t.target)){let e=t.target;for(t.preventDefault(),t.stopPropagation();"li"!==e.nodeName.toLowerCase();)if(e=e.parentNode,!e||e===i.menu){e=void 0;break}if(!e)return;if("true"===e.getAttribute("data-disabled"))return;0===i.current.filteredItems.length&&e.setAttribute("data-index",-1),i.selectItemAtIndex(e.getAttribute("data-index"),t),i.hideMenu()}else i.current.externalTrigger?i.current.externalTrigger=!1:i.current.element&&!i.current.externalTrigger&&setTimeout((()=>i.hideMenu()))}keyup(e,t){if(e.inputEvent&&(e.inputEvent=!1),e.updateSelection(this),t.keyCode&&27!==t.keyCode){if(!e.tribute.allowSpaces&&e.tribute.hasTrailingSpace)return e.tribute.hasTrailingSpace=!1,e.commandEvent=!0,void e.callbacks().space(t,this);if(!e.tribute.isActive)if(e.tribute.autocompleteMode)e.callbacks().triggerChar(t,this,"");else{let i=e.getKeyCode(e,this,t);if(isNaN(i)||!i)return;let n=e.tribute.triggers().find((e=>e.charCodeAt(0)===i));void 0!==n&&e.callbacks().triggerChar(t,this,n)}e.tribute.current.mentionText.length<e.tribute.current.collection.menuShowMinLength?e.tribute.hideMenu():((e.tribute.current.trigger||e.tribute.autocompleteMode)&&!1===e.commandEvent||8===t.keyCode)&&e.tribute.showMenuFor(this,!0)}}shouldDeactivate(t){if(!this.tribute.isActive)return!1;if(0===this.tribute.current.mentionText.length){let i=!1;return e.keys().forEach((e=>{t.keyCode===e.key&&(i=!0)})),!i}return!1}getKeyCode(e,t,i){let n=e.tribute,r=n.range.getTriggerInfo(!1,n.hasTrailingSpace,!0,n.allowSpaces,n.autocompleteMode);return!!r&&r.mentionTriggerChar.charCodeAt(0)}updateSelection(e){this.tribute.current.element=e;let t=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);t&&(this.tribute.current.selectedPath=t.mentionSelectedPath,this.tribute.current.mentionText=t.mentionText,this.tribute.current.selectedOffset=t.mentionSelectedOffset)}callbacks(){return{triggerChar:(e,t,i)=>{let n=this.tribute;n.current.trigger=i;let r=n.collection.find((e=>e.trigger===i));n.current.collection=r,n.current.mentionText.length>=n.current.collection.menuShowMinLength&&n.inputEvent&&n.showMenuFor(t,!0)},enter:(e,t)=>{const i=this.tribute.current.filteredItems;this.tribute.isActive&&i&&i.length&&(e.preventDefault(),e.stopPropagation(),0===this.tribute.current.filteredItems.length&&(this.tribute.menuSelected=-1),setTimeout((()=>{this.tribute.selectItemAtIndex(this.tribute.menuSelected,e),this.tribute.hideMenu()}),0))},escape:(e,t)=>{this.tribute.isActive&&(e.preventDefault(),e.stopPropagation(),this.tribute.isActive=!1,this.tribute.hideMenu())},tab:(e,t)=>{this.callbacks().enter(e,t)},space:(e,t)=>{this.tribute.isActive&&(this.tribute.spaceSelectsMatch?this.callbacks().enter(e,t):this.tribute.allowSpaces||(e.stopPropagation(),setTimeout((()=>{this.tribute.hideMenu(),this.tribute.isActive=!1}),0)))},up:(e,t)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){e.preventDefault(),e.stopPropagation();let t=this.tribute.current.filteredItems.length,i=this.tribute.menu.querySelectorAll("li");if(-1===this.tribute.menuSelected)return;do{this.tribute.menuSelected--,-1===this.tribute.menuSelected&&(this.tribute.menuSelected=t-1,this.tribute.menu.scrollTop=this.tribute.menu.scrollHeight)}while("true"===i[this.tribute.menuSelected].getAttribute("data-disabled"));this.setActiveLi()}},down:(e,t)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){e.preventDefault(),e.stopPropagation();let t=this.tribute.current.filteredItems.length,i=this.tribute.menu.querySelectorAll("li");if(-1===this.tribute.menuSelected)return;do{this.tribute.menuSelected++,this.tribute.menuSelected>=t&&(this.tribute.menuSelected=0,this.tribute.menu.scrollTop=0)}while("true"===i[this.tribute.menuSelected].getAttribute("data-disabled"));this.setActiveLi()}},delete:(e,t)=>{this.tribute.isActive&&this.tribute.current.mentionText.length<1?this.tribute.hideMenu():this.tribute.isActive&&this.tribute.showMenuFor(t)}}}setActiveLi(e){let t=this.tribute.menu.querySelectorAll("li"),i=t.length>>>0;e&&(this.tribute.menuSelected=parseInt(e));for(let e=0;e<i;e++){let i=t[e];if(e===this.tribute.menuSelected){"true"!==i.getAttribute("data-disabled")&&i.classList.add(this.tribute.current.collection.selectClass);let e=i.getBoundingClientRect(),t=this.tribute.menu.getBoundingClientRect();if(e.bottom>t.bottom){let i=e.bottom-t.bottom;this.tribute.menu.scrollTop+=i}else if(e.top<t.top){let i=t.top-e.top;this.tribute.menu.scrollTop-=i}}else i.classList.remove(this.tribute.current.collection.selectClass)}}getFullHeight(e,t){let i=e.getBoundingClientRect().height;if(t){let t=e.currentStyle||window.getComputedStyle(e);return i+parseFloat(t.marginTop)+parseFloat(t.marginBottom)}return i}}class t{constructor(e){this.tribute=e,this.tribute.menuEvents=this,this.menu=this.tribute.menu}bind(e){this.menuClickEvent=this.tribute.events.click.bind(null,this),this.menuContainerScrollEvent=this.debounce((()=>{this.tribute.isActive&&this.tribute.hideMenu()}),10,!1),this.windowResizeEvent=this.debounce((()=>{this.tribute.isActive&&this.tribute.hideMenu()}),10,!1),this.closeOnScrollEvent=this.debounce((()=>{this.tribute.isActive&&this.tribute.hideMenu()}),10,!1),this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1),this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1),window.addEventListener("resize",this.windowResizeEvent),1==this.tribute.closeOnScroll?window.addEventListener("scroll",this.closeOnScrollEvent):0!=this.tribute.closeOnScroll?this.tribute.closeOnScroll.addEventListener("scroll",this.closeOnScrollEvent,!1):this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}unbind(e){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1),this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1),window.removeEventListener("resize",this.windowResizeEvent),!0===this.tribute.closeOnScroll?window.removeEventListener("scroll",this.closeOnScrollEvent):0!=this.tribute.closeOnScroll?this.tribute.closeOnScroll.removeEventListener("scroll",this.closeOnScrollEvent):this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}debounce(e,t,i){var n;return()=>{var r=this,o=arguments,s=i&&!n;clearTimeout(n),n=setTimeout((()=>{n=null,i||e.apply(r,o)}),t),s&&e.apply(r,o)}}}class i{constructor(e){this.tribute=e,this.tribute.range=this}getDocument(){let e;return this.tribute.current.collection&&(e=this.tribute.current.collection.iframe),e?e.contentWindow.document:document}positionMenuAtCaret(e){let t,i=this.tribute.current,n=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(void 0!==n){if(!this.tribute.positionMenu)return void(this.tribute.menu.style.cssText="display: block;");t=this.isContentEditable(i.element)?this.getContentEditableCaretPosition(n.mentionPosition):this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,n.mentionPosition),this.tribute.menu.style.cssText=`top: ${t.top}px;\n                                     left: ${t.left}px;\n                                     right: ${t.right}px;\n                                     bottom: ${t.bottom}px;\n                                     max-height: ${t.maxHeight||500}px;\n                                     max-width: ${t.maxWidth||300}px;\n                                     position: ${t.position||"absolute"};\n                                     display: block;`,"auto"===t.left&&(this.tribute.menu.style.left="auto"),"auto"===t.top&&(this.tribute.menu.style.top="auto"),e&&this.scrollIntoView()}else this.tribute.menu.style.cssText="display: none"}get menuContainerIsBody(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}selectElement(e,t,i){let n,r=e;if(t)for(var o=0;o<t.length;o++){if(r=r.childNodes[t[o]],void 0===r)return;for(;r.length<i;)i-=r.length,r=r.nextSibling;0!==r.childNodes.length||r.length||(r=r.previousSibling)}let s=this.getWindowSelection();n=this.getDocument().createRange(),n.setStart(r,i),n.setEnd(r,i),n.collapse(!0);try{s.removeAllRanges()}catch(e){}s.addRange(n),e.focus()}replaceTriggerText(e,t,i,n,r){let o=this.getTriggerInfo(!0,i,t,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(void 0!==o){let t=this.tribute.current,i=new CustomEvent("tribute-replaced",{detail:{item:r,instance:t,context:o,event:n}});if(this.isContentEditable(t.element)){let t="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";e instanceof HTMLElement||(e+=t);let i=o.mentionPosition+o.mentionText.length;this.tribute.autocompleteMode||(i+=o.mentionTriggerChar.length),this.pasteHtml(e,o.mentionPosition,i)}else{let t=this.tribute.current.element,i="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";e+=i;let n=o.mentionPosition,r=o.mentionPosition+o.mentionText.length+(""===i?1:i.length);this.tribute.autocompleteMode||(r+=o.mentionTriggerChar.length-1),t.value=t.value.substring(0,n)+e+t.value.substring(r,t.value.length),t.selectionStart=n+e.length,t.selectionEnd=n+e.length}t.element.dispatchEvent(new CustomEvent("input",{bubbles:!0})),t.element.dispatchEvent(i)}}pasteHtml(e,t,i){let n,r;r=this.getWindowSelection(),n=this.getDocument().createRange(),n.setStart(r.anchorNode,t),n.setEnd(r.anchorNode,i),n.deleteContents();let o=this.getDocument().createElement("div");e instanceof HTMLElement?o.appendChild(e):o.innerHTML=e;let s,l,u=this.getDocument().createDocumentFragment();for(;s=o.firstChild;)l=u.appendChild(s);n.insertNode(u),l&&(n=n.cloneRange(),n.setStartAfter(l),n.collapse(!0),r.removeAllRanges(),r.addRange(n))}getWindowSelection(){return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():this.tribute.collection[0].shadowRoot?this.tribute.collection[0].shadowRoot.getSelection():window.getSelection()}getNodePositionInParent(e){if(null===e.parentNode)return 0;for(var t=0;t<e.parentNode.childNodes.length;t++){if(e.parentNode.childNodes[t]===e)return t}}getContentEditableSelectedPath(e){let t,i=this.getWindowSelection(),n=i.anchorNode,r=[];if(null!=n){let e,o=n.contentEditable;for(;null!==n&&"true"!==o;)e=this.getNodePositionInParent(n),r.push(e),n=n.parentNode,null!==n&&(o=n.contentEditable);return r.reverse(),t=i.getRangeAt(0).startOffset,{selected:n,path:r,offset:t}}}getTextPrecedingCurrentSelection(){let e=this.tribute.current,t="";if(this.isContentEditable(e.element)){let e=this.getWindowSelection().anchorNode;if(null!=e){let i=e.textContent,n=this.getWindowSelection().getRangeAt(0).startOffset;i&&n>=0&&(t=i.substring(0,n))}}else{let e=this.tribute.current.element;if(e){let i=e.selectionStart;e.value&&i>=0&&(t=e.value.substring(0,i))}}return t}getLastWordInText(e){var t;return(t=this.tribute.autocompleteMode?this.tribute.autocompleteSeparator?e.split(this.tribute.autocompleteSeparator):[e]:e.split(/\s+/))[t.length-1]}getTriggerInfo(e,t,i,n,r){let o,s,l,u=this.tribute.current;if(this.isContentEditable(u.element)){let e=this.getContentEditableSelectedPath(u);e&&(o=e.selected,s=e.path,l=e.offset)}else o=this.tribute.current.element;let c=this.getTextPrecedingCurrentSelection(),a=this.getLastWordInText(c);if(r)return{mentionPosition:c.length-a.length,mentionText:a,mentionSelectedElement:o,mentionSelectedPath:s,mentionSelectedOffset:l};if(null!=c){let r,u=-1;if(this.tribute.collection.forEach((e=>{let t=e.trigger,n=e.requireLeadingSpace?this.lastIndexWithLeadingSpace(c,t):c.lastIndexOf(t);n>u&&(u=n,r=t,i=e.requireLeadingSpace)})),u>=0&&(0===u||!i||/\s/.test(c.substring(u-1,u)))){let i=c.substring(u+r.length,c.length);r=c.substring(u,u+r.length);let a=i.substring(0,1),h=i.length>0&&(" "===a||" "===a);t&&(i=i.trim());let d=n?/[^\S ]/g:/[\xA0\s]/g;if(this.tribute.hasTrailingSpace=d.test(i),!h&&(e||!d.test(i)))return{mentionPosition:u,mentionText:i,mentionSelectedElement:o,mentionSelectedPath:s,mentionSelectedOffset:l,mentionTriggerChar:r}}}}lastIndexWithLeadingSpace(e,t){let i=e.split("").reverse().join(""),n=-1;for(let r=0,o=e.length;r<o;r++){let o=r===e.length-1,s=/\s/.test(i[r+1]),l=!0;for(let e=t.length-1;e>=0;e--)if(t[e]!==i[r-e]){l=!1;break}if(l&&(o||s)){n=e.length-1-r;break}}return n}isContentEditable(e){return"INPUT"!==e.nodeName&&"TEXTAREA"!==e.nodeName}isMenuOffScreen(e,t){let i=window.innerWidth,n=window.innerHeight,r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),s=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l="number"==typeof e.top?e.top:s+n-e.bottom-t.height,u="number"==typeof e.right?e.right:e.left+t.width,c="number"==typeof e.bottom?e.bottom:e.top+t.height,a="number"==typeof e.left?e.left:o+i-e.right-t.width;return{top:l<Math.floor(s),right:u>Math.ceil(o+i),bottom:c>Math.ceil(s+n),left:a<Math.floor(o)}}getMenuDimensions(){let e={width:null,height:null};return this.tribute.menu.style.cssText="top: 0px;\n                                 left: 0px;\n                                 position: fixed;\n                                 display: block;\n                                 visibility; hidden;\n                                 max-height:500px;",e.width=this.tribute.menu.offsetWidth,e.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.cssText="display: none;",e}getTextAreaOrInputUnderlinePosition(e,t,i){let n=this.getDocument().createElement("div");n.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(n);let r=n.style,o=window.getComputedStyle?getComputedStyle(e):e.currentStyle;r.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(r.wordWrap="break-word"),r.position="absolute",r.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach((e=>{r[e]=o[e]}));let s=document.createElement("span");s.textContent=e.value.substring(0,t),n.appendChild(s),"INPUT"===e.nodeName&&(n.textContent=n.textContent.replace(/\s/g," "));let l=this.getDocument().createElement("span");l.textContent="&#x200B;",n.appendChild(l);let u=this.getDocument().createElement("span");u.textContent=e.value.substring(t),n.appendChild(u);let c=e.getBoundingClientRect();n.style.position="fixed",n.style.left=c.left+"px",n.style.top=c.top+"px",n.style.width=c.width+"px",n.style.height=c.height+"px",n.scrollTop=e.scrollTop;var a=l.getBoundingClientRect();return this.getDocument().body.removeChild(n),this.getFixedCoordinatesRelativeToRect(a)}getContentEditableCaretPosition(e){let t,i=this.getWindowSelection();t=this.getDocument().createRange(),t.setStart(i.anchorNode,e),t.setEnd(i.anchorNode,e),t.collapse(!1);let n=t.getBoundingClientRect();return this.getFixedCoordinatesRelativeToRect(n)}getFixedCoordinatesRelativeToRect(e){let t={position:"fixed",left:e.left,top:e.top+e.height},i=this.getMenuDimensions();var n=e.top,r=window.innerHeight-(e.top+e.height);r<i.height&&(n>=i.height||n>r?(t.top="auto",t.bottom=window.innerHeight-e.top,r<i.height&&(t.maxHeight=n)):n<i.height&&(t.maxHeight=r));var o=e.left,s=window.innerWidth-e.left;return s<i.width&&(o>=i.width||o>s?(t.left="auto",t.right=window.innerWidth-e.left,s<i.width&&(t.maxWidth=o)):o<i.width&&(t.maxWidth=s)),t}scrollIntoView(e){let t,i=this.menu;if(void 0===i)return;for(;void 0===t||0===t.height;)if(t=i.getBoundingClientRect(),0===t.height&&(i=i.childNodes[0],void 0===i||!i.getBoundingClientRect))return;let n=t.top,r=n+t.height;if(n<0)window.scrollTo(0,window.pageYOffset+t.top-20);else if(r>window.innerHeight){let e=window.pageYOffset+t.top-20;e-window.pageYOffset>100&&(e=window.pageYOffset+100);let i=window.pageYOffset-(window.innerHeight-r);i>e&&(i=e),window.scrollTo(0,i)}}}class n{constructor(e){this.tribute=e,this.tribute.search=this}simpleFilter(e,t){return t.filter((t=>this.test(e,t)))}test(e,t){return null!==this.match(e,t)}match(e,t,i){i=i||{},t.length;let n=i.pre||"",r=i.post||"",o=i.caseSensitive&&t||t.toLowerCase();if(i.skip)return{rendered:t,score:0};e=i.caseSensitive&&e||e.toLowerCase();let s=this.traverse(o,e,0,0,[]);return s?{rendered:this.render(t,s.cache,n,r),score:s.score}:null}traverse(e,t,i,n,r){if(this.tribute.autocompleteSeparator&&(t=t.split(this.tribute.autocompleteSeparator).splice(-1)[0]),t.length===n)return{score:this.calculateScore(r),cache:r.slice()};if(e.length===i||t.length-n>e.length-i)return;let o,s,l=t[n],u=e.indexOf(l,i);for(;u>-1;){if(r.push(u),s=this.traverse(e,t,u+1,n+1,r),r.pop(),!s)return o;(!o||o.score<s.score)&&(o=s),u=e.indexOf(l,u+1)}return o}calculateScore(e){let t=0,i=1;return e.forEach(((n,r)=>{r>0&&(e[r-1]+1===n?i+=i+1:i=1),t+=i})),t}render(e,t,i,n){var r=e.substring(0,t[0]);return t.forEach(((o,s)=>{r+=i+e[o]+n+e.substring(o+1,t[s+1]?t[s+1]:e.length)})),r}filter(e,t,i){return i=i||{},t.reduce(((t,n,r,o)=>{let s=n;i.extract&&(s=i.extract(n),s||(s=""));let l=this.match(e,s,i);return null!=l&&(t[t.length]={string:l.rendered,score:l.score,index:r,original:n}),t}),[]).sort(((e,t)=>{let i=t.score-e.score;return i||e.index-t.index}))}}class r{constructor({values:o=null,loadingItemTemplate:s=null,iframe:l=null,shadowRoot:u=null,selectClass:c="highlight",containerClass:a="tribute-container",itemClass:h="",trigger:d="@",autocompleteMode:m=!1,autocompleteSeparator:p=/\s+/,selectTemplate:g=null,menuItemTemplate:b=null,lookup:f="key",fillAttr:v="value",collection:w=null,menuContainer:T=null,noMatchTemplate:S=null,requireLeadingSpace:C=!0,allowSpaces:x=!1,replaceTextSuffix:E=null,positionMenu:y=!0,spaceSelectsMatch:M=!1,searchOpts:A={},menuItemLimit:L=null,menuShowMinLength:I=0,closeOnScroll:k=!1,maxDisplayItems:N=null,isBlocked:D=!1}){if(this.autocompleteMode=m,this.autocompleteSeparator=p,this.menuSelected=0,this.current={},this.inputEvent=!1,this.isActive=!1,this.menuContainer=T,this.allowSpaces=x,this.replaceTextSuffix=E,this.positionMenu=y,this.hasTrailingSpace=!1,this.spaceSelectsMatch=M,this.closeOnScroll=k,this.autocompleteMode&&(d="",x=!1),o)this.collection=[{trigger:d,iframe:l,shadowRoot:u,selectClass:c,containerClass:a,itemClass:h,selectTemplate:(g||r.defaultSelectTemplate).bind(this),menuItemTemplate:(b||r.defaultMenuItemTemplate).bind(this),noMatchTemplate:(e=>"string"==typeof e?""===e.trim()?null:e:"function"==typeof e?e.bind(this):S||function(){return"<li>No Match Found!</li>"}.bind(this))(S),lookup:f,fillAttr:v,values:o,loadingItemTemplate:s,requireLeadingSpace:C,searchOpts:A,menuItemLimit:L,menuShowMinLength:I,maxDisplayItems:N,isBlocked:D}];else{if(!w)throw new Error("[Tribute] No collection specified.");this.autocompleteMode&&console.warn("Tribute in autocomplete mode does not work for collections"),this.collection=w.map((e=>({trigger:e.trigger||d,iframe:e.iframe||l,selectClass:e.selectClass||c,containerClass:e.containerClass||a,itemClass:e.itemClass||h,selectTemplate:(e.selectTemplate||r.defaultSelectTemplate).bind(this),menuItemTemplate:(e.menuItemTemplate||r.defaultMenuItemTemplate).bind(this),noMatchTemplate:(e=>"string"==typeof e?""===e.trim()?null:e:"function"==typeof e?e.bind(this):S||function(){return"<li>No Match Found!</li>"}.bind(this))(S),lookup:e.lookup||f,fillAttr:e.fillAttr||v,values:e.values,loadingItemTemplate:e.loadingItemTemplate,requireLeadingSpace:e.requireLeadingSpace,searchOpts:e.searchOpts||A,menuItemLimit:e.menuItemLimit||L,menuShowMinLength:e.menuShowMinLength||I,maxDisplayItems:e.maxDisplayItems||N,isBlocked:e.isBlocked||D})))}new i(this),new e(this),new t(this),new n(this)}get isActive(){return this._isActive}set isActive(e){if(this._isActive!=e&&(this._isActive=e,this.current.element)){let t=new CustomEvent(`tribute-active-${e}`);this.current.element.dispatchEvent(t)}}static defaultSelectTemplate(e){return void 0===e?`${this.current.collection.trigger}${this.current.mentionText}`:this.range.isContentEditable(this.current.element)?'<span class="tribute-mention">'+(this.current.collection.trigger+e.original[this.current.collection.fillAttr])+"</span>":this.current.collection.trigger+e.original[this.current.collection.fillAttr]}static defaultMenuItemTemplate(e){return e.string}static inputTypes(){return["TEXTAREA","INPUT"]}triggers(){return this.collection.map((e=>e.trigger))}attach(e){if(!e)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&e instanceof jQuery&&(e=e.get()),e.constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array){let i=e.length;for(var t=0;t<i;++t)this._attach(e[t])}else this._attach(e)}_attach(e){e.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+e.nodeName),this.ensureEditable(e),this.events.bind(e),e.setAttribute("data-tribute",!0)}ensureEditable(e){if(-1===r.inputTypes().indexOf(e.nodeName)){if("string"!=typeof e.contentEditable)throw new Error("[Tribute] Cannot bind to "+e.nodeName+", not contentEditable");e.contentEditable=!0}}createMenu(e){let t=this.range.getDocument().createElement("div"),i=this.range.getDocument().createElement("ul");return t.className=e,t.appendChild(i),this.menuContainer?this.menuContainer.appendChild(t):this.range.getDocument().body.appendChild(t)}showMenuFor(e,t){if(this.current.collection.maxDisplayItems&&e.querySelectorAll('[data-tribute-trigger="'+this.current.collection.trigger+'"]').length>=this.current.collection.maxDisplayItems||this.current.collection.isBlocked)return;this.currentMentionTextSnapshot=this.current.mentionText,this.menu||(this.menu=this.createMenu(this.current.collection.containerClass),e.tributeMenu=this.menu,this.menuEvents.bind(this.menu)),this.isActive=!0,this.menuSelected=0,window.setTimeout((()=>{this.menu.scrollTop=0}),0),this.current.mentionText||(this.current.mentionText="");const i=e=>{if(!this.isActive)return;let i=this.search.filter(this.current.mentionText,e,{pre:this.current.collection.searchOpts.pre||"<span>",post:this.current.collection.searchOpts.post||"</span>",skip:this.current.collection.searchOpts.skip||!1,caseSensitive:this.current.collection.searchOpts.caseSensitive||!1,extract:e=>{if("string"==typeof this.current.collection.lookup)return e[this.current.collection.lookup];if("function"==typeof this.current.collection.lookup)return this.current.collection.lookup(e,this.current.mentionText);throw new Error("Invalid lookup attribute, lookup must be string or function.")}});this.current.collection.menuItemLimit&&(i=i.slice(0,this.current.collection.menuItemLimit)),this.current.filteredItems=i;let n=this.menu.querySelector("ul");if(!i.length){let e=new CustomEvent("tribute-no-match",{detail:this.menu});return this.current.element.dispatchEvent(e),void("function"==typeof this.current.collection.noMatchTemplate&&!this.current.collection.noMatchTemplate()||!this.current.collection.noMatchTemplate?this.hideMenu():("function"==typeof this.current.collection.noMatchTemplate?n.innerHTML=this.current.collection.noMatchTemplate():n.innerHTML=this.current.collection.noMatchTemplate,this.range.positionMenuAtCaret(t)))}n.innerHTML="";let r=this.range.getDocument().createDocumentFragment();this.menuSelected=i.findIndex((e=>!0!==e.original.disabled)),i.forEach(((e,t)=>{let i=this.range.getDocument().createElement("li");i.setAttribute("data-index",t),e.original.disabled&&i.setAttribute("data-disabled","true"),i.className=this.current.collection.itemClass,i.addEventListener("mousemove",(e=>{let[t,i]=this._findLiTarget(e.target);0!==e.movementY&&this.events.setActiveLi(i)})),this.menuSelected===t&&i.classList.add(this.current.collection.selectClass);const n=this.current.collection.menuItemTemplate(e);n instanceof Element?(i.innerHTML="",i.appendChild(n)):i.innerHTML=n,r.appendChild(i)})),n.appendChild(r),this.range.positionMenuAtCaret(t)};"function"==typeof this.current.collection.values?(this.current.collection.loadingItemTemplate&&(this.menu.querySelector("ul").innerHTML=this.current.collection.loadingItemTemplate,this.range.positionMenuAtCaret(t)),this.current.collection.values(this.current.mentionText,i)):i(this.current.collection.values)}_findLiTarget(e){if(!e)return[];const t=e.getAttribute("data-index");return t?[e,t]:this._findLiTarget(e.parentNode)}showMenuForCollection(e,t){this.collection[t||0].maxDisplayItems&&e.querySelectorAll('[data-tribute-trigger="'+this.collection[t||0].trigger+'"]').length>=this.collection[t||0].maxDisplayItems||this.collection[t||0].isBlocked||(e!==document.activeElement&&this.placeCaretAtEnd(e),this.current.collection=this.collection[t||0],this.current.externalTrigger=!0,this.current.element=e,e.isContentEditable?this.insertTextAtCursor(this.current.collection.trigger):this.insertAtCaret(e,this.current.collection.trigger),this.showMenuFor(e))}placeCaretAtEnd(e){if(e.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var i=window.getSelection();i.removeAllRanges(),i.addRange(t)}else if(void 0!==document.body.createTextRange){var n=document.body.createTextRange();n.moveToElementText(e),n.collapse(!1),n.select()}}insertTextAtCursor(e){var t,i;(i=(t=window.getSelection()).getRangeAt(0)).deleteContents();var n=document.createTextNode(e);i.insertNode(n),i.selectNodeContents(n),i.collapse(!1),t.removeAllRanges(),t.addRange(i)}insertAtCaret(e,t){var i=e.scrollTop,n=e.selectionStart,r=e.value.substring(0,n),o=e.value.substring(e.selectionEnd,e.value.length);e.value=r+t+o,n+=t.length,e.selectionStart=n,e.selectionEnd=n,e.focus(),e.scrollTop=i}hideMenu(){this.menu&&(this.menu.style.cssText="display: none;",this.isActive=!1,this.menuSelected=0,this.current={})}selectItemAtIndex(e,t){if("number"!=typeof(e=parseInt(e))||isNaN(e))return;let i=this.current.filteredItems[e],n=this.current.collection.selectTemplate(i);if(-1!==e)null!==n&&this.replaceText(n,t,i);else{let e=new CustomEvent("tribute-selected-no-match",{detail:n});this.current.element.dispatchEvent(e)}}replaceText(e,t,i){this.range.replaceTriggerText(e,!0,!0,t,i)}_append(e,t,i){if("function"==typeof e.values)throw new Error("Unable to append to values, as it is a function.");e.values=i?t:e.values.concat(t)}append(e,t,i){let n=parseInt(e);if("number"!=typeof n)throw new Error("please provide an index for the collection to update.");let r=this.collection[n];this._append(r,t,i)}appendCurrent(e,t){if(!this.isActive)throw new Error("No active state. Please use append instead and pass an index.");this._append(this.current.collection,e,t)}detach(e){if(!e)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&e instanceof jQuery&&(e=e.get()),e.constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array){let i=e.length;for(var t=0;t<i;++t)this._detach(e[t])}else this._detach(e)}_detach(e){this.events.unbind(e),e.tributeMenu&&this.menuEvents.unbind(e.tributeMenu),setTimeout((()=>{e.removeAttribute("data-tribute"),this.isActive=!1,e.tributeMenu&&e.tributeMenu.remove()}))}}export{r as default};
